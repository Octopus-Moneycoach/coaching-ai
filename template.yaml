AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Meeting Summariser - Async Agentic Flow

Parameters:
  SummaryBucketName:
    Type: String
    Description: Name of existing S3 bucket for summaries and transcripts
    Default: ""
  GoldenDataBucketName:
    Type: String
    Description: Name of existing S3 bucket for training data
    Default: ""

Conditions:
  CreateSummaryBucket: !Equals
    - !Ref SummaryBucketName
    - ""
  CreateGoldenDataBucket: !Equals
    - !Ref GoldenDataBucketName
    - ""

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Architectures:
      - arm64
    Tracing: Active
    Environment:
      Variables:
        # S3 layout + versions (Athena partitioned)
        S3_PREFIX: "summaries"
        SUMMARY_SCHEMA_VERSION: "1.2"
        ATHENA_PARTITIONED: "true"
        MODEL_VERSION: "bedrock:claude-3-7-sonnet-20250219"
        MODEL_ID: "anthropic.claude-3-7-sonnet-20250219-v1:0"
        PROMPT_VERSION: "2025-09-22-a"
        INSIGHTS_VERSION: "2025-08-30-a"
        CASE_CHECK_SCHEMA_VERSION: "1.0"
        SAVE_TRANSCRIPTS: "true"
        ZOOM_PARAM_PREFIX: "/zoom/s2s"
        # Knowledge Base Configuration
        # KNOWLEDGE_BASE_ID is read from Parameter Store at runtime
        KNOWLEDGE_BASE_PARAM_NAME: "/call-summariser/knowledge-base-id"
        USE_KNOWLEDGE_BASE: "false"
        # Prompt Management Configuration
        USE_PROMPT_MANAGEMENT: "true"
        PROMPT_PARAM_NAME_SUMMARY: "/call-summariser/prompts/summary/current"
        PROMPT_PARAM_NAME_CASE_CHECK: "/call-summariser/prompts/case-check/current"
        # A2I â€” set Flow ARN when ready; leave portal URL empty if not used in UI
        A2I_FLOW_ARN_CASE: "arn:aws:sagemaker:eu-west-2:058264250790:flow-definition/case-check-flow-min"
        A2I_PORTAL_URL: ""
        # DynamoDB tables and S3 buckets - set globally for all Lambdas
        SUMMARY_JOB_TABLE: !Ref SummaryJobTable
        SUMMARY_BUCKET: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        ASSESSMENT_RESULTS_TABLE: !Ref AssessmentResultsTable
        GOLDEN_DATA_BUCKET: !If [CreateGoldenDataBucket, !Ref GoldenDataBucket, !Ref GoldenDataBucketName]
        CASE_CHECK_DEFINITIONS_TABLE: !Ref CaseCheckDefinitionsTable

Resources:
  ### Shared Dependencies Layer ###
  SharedDependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: shared-python-libs
      Description: Common Python packages (pydantic, boto3, etc.)
      ContentUri: layers/shared-python
      CompatibleRuntimes:
        - python3.11
    Metadata:
      BuildMethod: python3.11

  ### EventBridge Event Bus ###
  SummariserEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: call-summariser-events


  ### S3 Bucket for Summaries ###
  SummaryBucket:
    Type: AWS::S3::Bucket
    Condition: CreateSummaryBucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: "DeleteOldSummaries"
            Prefix: "summaries/"
            Status: Enabled
            ExpirationInDays: 90
          - Id: "DeleteOldAthenaResults"
            Prefix: "athena-results/"
            Status: Enabled
            ExpirationInDays: 30

  ### S3 Bucket for Golden Data (ML Training Datasets) ###
  GoldenDataBucket:
    Type: AWS::S3::Bucket
    Condition: CreateGoldenDataBucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-golden-data"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: "TransitionOldDataToGlacier"
            Prefix: "training-data/"
            Status: Enabled
            Transitions:
              - TransitionInDays: 365
                StorageClass: GLACIER
          - Id: "DeleteOldEvaluations"
            Prefix: "evaluations/"
            Status: Enabled
            ExpirationInDays: 180

  ### DynamoDB Table for Job Status ###
  SummaryJobTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: summary-job-status
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: meetingId
          AttributeType: S
      KeySchema:
        - AttributeName: meetingId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  ### DynamoDB Table for Summary Metadata Index ###
  SummaryMetadataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: summary-metadata-index
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: meetingId
          AttributeType: S
        - AttributeName: versionTimestamp
          AttributeType: S
        - AttributeName: version
          AttributeType: S
      KeySchema:
        - AttributeName: meetingId
          KeyType: HASH
        - AttributeName: versionTimestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: VersionIndex
          KeySchema:
            - AttributeName: version
              KeyType: HASH
            - AttributeName: versionTimestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  ### DynamoDB Table for ALL Assessments (Unified Pro Architecture) ###
  AssessmentResultsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: assessment-results
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: meeting_id
          AttributeType: S
        - AttributeName: assessment_id
          AttributeType: S
        - AttributeName: review_status
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
        - AttributeName: assessment_type
          AttributeType: S
        - AttributeName: reviewed_by
          AttributeType: S
        - AttributeName: reviewed_at
          AttributeType: S
      KeySchema:
        - AttributeName: meeting_id
          KeyType: HASH
        - AttributeName: assessment_id
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: ReviewStatusIndex
          KeySchema:
            - AttributeName: review_status
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: AssessmentTypeIndex
          KeySchema:
            - AttributeName: assessment_type
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ReviewStatusTypeIndex
          KeySchema:
            - AttributeName: review_status
              KeyType: HASH
            - AttributeName: assessment_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: CoachIndex
          KeySchema:
            - AttributeName: reviewed_by
              KeyType: HASH
            - AttributeName: reviewed_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true

  ### DynamoDB Table for Case Check Definitions (Configuration) ###
  CaseCheckDefinitionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: case-check-definitions
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: check_id
          AttributeType: S
        - AttributeName: session_type
          AttributeType: S
        - AttributeName: order
          AttributeType: N
      KeySchema:
        - AttributeName: check_id
          KeyType: HASH
        - AttributeName: session_type
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: SessionTypeIndex
          KeySchema:
            - AttributeName: session_type
              KeyType: HASH
            - AttributeName: order
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  ### Step Functions State Machine ###
  SummariserStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: call-summariser-workflow
      DefinitionUri: statemachine/summariser-workflow.asl.json
      DefinitionSubstitutions:
        FetchTranscriptFunctionArn: !GetAtt FetchTranscriptFunction.Arn
        NormaliseRolesFunctionArn: !GetAtt NormaliseRolesFunction.Arn
        PIIDetectRedactFunctionArn: !GetAtt PIIDetectRedactFunction.Arn
        SummariseFunctionArn: !GetAtt SummariseFunction.Arn
        ValidateRepairFunctionArn: !GetAtt ValidateRepairFunction.Arn
        CaseCheckFunctionArn: !GetAtt CaseCheckFunction.Arn
        PersistSummaryFunctionArn: !GetAtt PersistSummaryFunction.Arn
        A2IReviewFunctionArn: !GetAtt A2IReviewFunction.Arn
        UpdateStatusFunctionArn: !GetAtt UpdateStatusFunction.Arn
        EventBusName: !Ref SummariserEventBus
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref FetchTranscriptFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref NormaliseRolesFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref PIIDetectRedactFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref SummariseFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ValidateRepairFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref CaseCheckFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref PersistSummaryFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref A2IReviewFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref UpdateStatusFunction
        - EventBridgePutEventsPolicy:
            EventBusName: !Ref SummariserEventBus

  ### Case Check State Machine (Independent) ###
  CaseCheckerStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: case-checker-workflow
      DefinitionUri: statemachine/case-checker-workflow.asl.json
      DefinitionSubstitutions:
        FetchTranscriptFunctionArn: !GetAtt FetchTranscriptFunction.Arn
        NormaliseRolesFunctionArn: !GetAtt NormaliseRolesFunction.Arn
        PIIDetectRedactFunctionArn: !GetAtt PIIDetectRedactFunction.Arn
        ExtractMetricsFunctionArn: !GetAtt ExtractMetricsFunction.Arn
        CaseCheckFunctionArn: !GetAtt CaseCheckFunction.Arn
        AssessVulnerabilityFunctionArn: !GetAtt AssessVulnerabilityFunction.Arn
        A2IReviewFunctionArn: !GetAtt A2IReviewFunction.Arn
        UpdateStatusFunctionArn: !GetAtt UpdateStatusFunction.Arn
        EventBusName: !Ref SummariserEventBus
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref FetchTranscriptFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref NormaliseRolesFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref PIIDetectRedactFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ExtractMetricsFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref CaseCheckFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref AssessVulnerabilityFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref A2IReviewFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref UpdateStatusFunction
        - EventBridgePutEventsPolicy:
            EventBusName: !Ref SummariserEventBus

  ### Step Functions Workflow Lambda Functions ###
  FetchTranscriptFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: fetch_transcript.app.lambda_handler
      Timeout: 120
      MemorySize: 512
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
                - ssm:PutParameter
              Resource:
                - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/zoom/s2s/*

  NormaliseRolesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: normalise_roles.app.lambda_handler
      Timeout: 30
      MemorySize: 256
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]

  PIIDetectRedactFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: pii_detect_redact.app.lambda_handler
      Timeout: 60
      MemorySize: 512
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - comprehend:DetectPiiEntities
              Resource: "*"

  SummariseFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: summarise.app.lambda_handler
      Timeout: 120
      MemorySize: 1024
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:GetPrompt
              Resource:
                - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:prompt/*"
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/call-summariser/*"

  ValidateRepairFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: validate_repair.app.lambda_handler
      Timeout: 90
      MemorySize: 512
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:GetPrompt
              Resource:
                - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:prompt/*"
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/call-summariser/*"

  CaseCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: case_check.app.lambda_handler
      Timeout: 300  # Increased for chunked processing (5 minutes)
      MemorySize: 1024
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - DynamoDBCrudPolicy:
            TableName: !Ref AssessmentResultsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CaseCheckDefinitionsTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:GetPrompt
              Resource:
                - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:prompt/*"
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/call-summariser/*"
            - Effect: Allow
              Action:
                - bedrock:Retrieve
                - bedrock:RetrieveAndGenerate
              Resource:
                - !Sub "arn:aws:bedrock:${AWS::Region}:*:knowledge-base/*"

  ### Extract Metrics Function (fast, deterministic metrics extraction) ###
  ExtractMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: extract_metrics.app.lambda_handler
      Timeout: 30  # Fast - no LLM calls
      MemorySize: 256
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]

  ### Assess Vulnerability Function (triggered when case check identifies vulnerabilities) ###
  AssessVulnerabilityFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: assess_vulnerability.app.lambda_handler
      Timeout: 180  # 3 minutes for detailed assessment
      MemorySize: 1024
      Environment:
        Variables:
          PROMPT_PARAM_NAME_VULNERABILITY: /call-summariser/prompts/vulnerability-assessment/current
      Policies:
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - DynamoDBCrudPolicy:
            TableName: !Ref AssessmentResultsTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:GetPrompt
              Resource:
                - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:prompt/*"
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/call-summariser/*"

  PersistSummaryFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: persist_summary.app.lambda_handler
      Timeout: 60
      MemorySize: 512
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - DynamoDBCrudPolicy:
            TableName: !Ref AssessmentResultsTable

  A2IReviewFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: a2i_review.app.lambda_handler
      Timeout: 60
      MemorySize: 256
      Policies:
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - sagemaker:StartHumanLoop
                - sagemaker:DescribeHumanLoop
              Resource: "*"

  UpdateStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: update_status.app.lambda_handler
      Timeout: 30
      MemorySize: 256
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SummaryJobTable

  ### Initiate Lambda (API Gateway Trigger) ###
  InitiateSummaryFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: initiate_summary.app.lambda_handler
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref SummariserStateMachine
      Events:
        Api:
          Type: Api
          Properties:
            Path: /summarise
            Method: post
      Policies:
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - DynamoDBCrudPolicy:
            TableName: !Ref SummaryJobTable
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !Ref SummariserStateMachine

  ### Initiate Case Check Lambda (API Gateway Trigger) ###
  InitiateCaseCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: initiate_case_check.app.lambda_handler
      Environment:
        Variables:
          CASE_CHECK_STATE_MACHINE_ARN: !Ref CaseCheckerStateMachine
      Events:
        Api:
          Type: Api
          Properties:
            Path: /case-check
            Method: post
      Policies:
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - DynamoDBCrudPolicy:
            TableName: !Ref SummaryJobTable
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !Ref CaseCheckerStateMachine


  ### Get Summary URL Lambda (returns signed URL for summary) ###
  GetSummaryUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: get_summary_url.app.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            Path: /status
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SummaryJobTable
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]

  ListSummariesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: list_summaries.app.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            Path: /summaries
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SummaryJobTable
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]

  GetCaseUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: get_case_url.app.lambda_handler
      Events:
        Api:
          Type: Api
          Properties:
            Path: /case
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SummaryJobTable
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]

  ### GET /reviews/pending - Fetch pending assessments (all types) ###
  GetPendingReviewsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: get_pending_reviews.app.lambda_handler
      Environment:
        Variables:
          ASSESSMENTS_TABLE: !Ref AssessmentResultsTable
      Events:
        GetApi:
          Type: Api
          Properties:
            Path: /reviews/pending
            Method: get
        OptionsApi:
          Type: Api
          Properties:
            Path: /reviews/pending
            Method: options
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref AssessmentResultsTable

  ### POST /review - Save coach review and mark assessment as reviewed ###
  SaveGroundTruthReviewFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: save_ground_truth_review.app.lambda_handler
      Environment:
        Variables:
          ASSESSMENTS_TABLE: !Ref AssessmentResultsTable
      Events:
        Api:
          Type: Api
          Properties:
            Path: /review
            Method: post
        OptionsApi:
          Type: Api
          Properties:
            Path: /review
            Method: options
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AssessmentResultsTable

  ### GET /transcript/{meetingId} - Retrieve redacted transcript for a meeting ###
  GetTranscriptFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: get_transcript.app.lambda_handler
      Timeout: 30
      MemorySize: 512
      Events:
        GetApi:
          Type: Api
          Properties:
            Path: /transcript/{meetingId}
            Method: get
        OptionsApi:
          Type: Api
          Properties:
            Path: /transcript/{meetingId}
            Method: options
      Policies:
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]

  ### A2I Review Poller (flip IN_REVIEW -> COMPLETED)
  ReviewPollerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: review_poller.app.lambda_handler # you add this small file
      Timeout: 60
      MemorySize: 512
      Events:
        Every5Minutes:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
            Enabled: true
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SummaryJobTable
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - S3CrudPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - sagemaker:DescribeHumanLoop
              Resource: "*"

  ### Feedback Stream Processor - Collects feedback to golden dataset ###
  FeedbackStreamProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: feedback_stream_processor.app.lambda_handler
      Timeout: 300
      MemorySize: 1024
      Events:
        AssessmentStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt AssessmentResultsTable.StreamArn
            StartingPosition: LATEST
            BatchSize: 100
            MaximumBatchingWindowInSeconds: 10
            ParallelizationFactor: 2
            MaximumRetryAttempts: 3
            BisectBatchOnFunctionError: true
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref AssessmentResultsTable
        - S3CrudPolicy:
            BucketName: !If [CreateGoldenDataBucket, !Ref GoldenDataBucket, !Ref GoldenDataBucketName]
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]

  ### Health Check Endpoint ###
  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: summariser/
      Runtime: python3.11
      Layers:
        - !Ref SharedDependenciesLayer
      Handler: health_check.app.lambda_handler
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          MODEL_VERSION: !Ref AWS::StackName
          SUMMARY_SCHEMA_VERSION: "1.2"
      Events:
        Api:
          Type: Api
          Properties:
            Path: /health
            Method: get
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SummaryJobTable
        - S3ReadPolicy:
            BucketName: !If [CreateSummaryBucket, !Ref SummaryBucket, !Ref SummaryBucketName]
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:GetPrompt
              Resource:
                - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:prompt/*"
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/call-summariser/*"

Outputs:
  SummariseApiUrl:
    Description: "POST endpoint to start a new summary job"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/summarise"
  CaseCheckApiUrl:
    Description: "POST endpoint to start a case check job"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/case-check"
