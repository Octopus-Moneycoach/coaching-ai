# Testing Vulnerability Assessment Flow - Pre-Checkin Guide

## Overview

This guide walks through testing the complete vulnerability assessment flow before checking in your code.

## Prerequisites

1. Bedrock prompt created and stored in Parameter Store
2. Lambda functions built and ready to deploy
3. AWS credentials configured

## Testing Steps

### Step 1: Build and Deploy

```bash
cd /Users/pree/Documents/AI\ POCs/call-summariser/call-summariser

# Build
sam build

# Deploy
sam deploy
```

**Expected Output:**
- All Lambda functions successfully packaged
- CloudFormation stack updated
- New `AssessVulnerabilityFunction` deployed

### Step 2: Verify Parameter Store

```bash
# Check vulnerability prompt ARN is stored
aws ssm get-parameter \
  --name "/call-summariser/prompts/vulnerability-assessment/current" \
  --region eu-west-2
```

**Expected Output:**
```json
{
  "Parameter": {
    "Name": "/call-summariser/prompts/vulnerability-assessment/current",
    "Value": "arn:aws:bedrock:eu-west-2:058264250790:prompt/OQNE6VMD21:1",
    "Type": "String"
  }
}
```

### Step 3: Test with a Meeting That Has Vulnerabilities

Pick a meeting ID that you know has vulnerability indicators (e.g., mentions health issues, financial stress).

```bash
# Find a suitable test meeting
aws dynamodb scan \
  --table-name assessment-results \
  --filter-expression "begins_with(assessment_id, :prefix)" \
  --expression-attribute-values '{":prefix":{"S":"case-check#"}}' \
  --projection-expression "meeting_id" \
  --limit 5 \
  --region eu-west-2
```

Pick one and trigger the workflow:

```bash
# Replace TEST_MEETING_ID with actual meeting ID
aws stepfunctions start-execution \
  --state-machine-arn "arn:aws:states:eu-west-2:058264250790:stateMachine:case-checker-workflow" \
  --input '{
    "meetingId": "TEST_MEETING_ID",
    "forceReprocess": true
  }' \
  --region eu-west-2
```

**Expected Output:**
```json
{
  "executionArn": "arn:aws:states:eu-west-2:058264250790:execution:case-checker-workflow:xxx",
  "startDate": "2025-01-18T..."
}
```

Save the `executionArn` for monitoring.

### Step 4: Monitor Execution

```bash
# Check execution status (use executionArn from above)
aws stepfunctions describe-execution \
  --execution-arn "arn:aws:states:eu-west-2:058264250790:execution:case-checker-workflow:xxx" \
  --region eu-west-2
```

**Expected Status Progression:**
1. `RUNNING` → Execution in progress
2. `SUCCEEDED` → Execution completed successfully

**Check which path was taken:**
```bash
# Get execution history to see if AssessVulnerability was called
aws stepfunctions get-execution-history \
  --execution-arn "arn:aws:states:eu-west-2:058264250790:execution:case-checker-workflow:xxx" \
  --region eu-west-2 \
  | grep -A 5 "AssessVulnerability"
```

### Step 5: Verify Lambda Logs

```bash
# Get AssessVulnerability Lambda logs (last 10 minutes)
aws logs tail /aws/lambda/call-summariser-AssessVulnerabilityFunction-* \
  --since 10m \
  --follow \
  --region eu-west-2
```

**Expected Log Events:**
```
VULNERABILITY_ASSESSMENT_START: meetingId=TEST_MEETING_ID
VULNERABILITY_ASSESSMENT_LLM_OK: latency_ms=...
VULNERABILITY_ASSESSMENT_SAVED: meeting_id=TEST_MEETING_ID
```

**Look for errors:**
- `PROMPT_ARN_NOT_FOUND` → Parameter Store not configured
- `TRANSCRIPT_NOT_FOUND` → S3 key issue
- `LLM_INVOCATION_FAILED` → Bedrock API error
- `ASSESSMENT_TABLE_UPDATE_FAILED` → DynamoDB error

### Step 6: Check DynamoDB Results

```bash
# Query vulnerability assessment result
aws dynamodb get-item \
  --table-name assessment-results \
  --key '{
    "meeting_id": {"S": "TEST_MEETING_ID"},
    "assessment_id": {"S": "vulnerability#TEST_MEETING_ID"}
  }' \
  --region eu-west-2
```

**Expected Output Structure:**
```json
{
  "Item": {
    "meeting_id": {"S": "TEST_MEETING_ID"},
    "assessment_id": {"S": "vulnerability#TEST_MEETING_ID"},
    "assessment_type": {"S": "vulnerability"},
    "vulnerability_rating": {"S": "Medium/3"},
    "vulnerability_types": {"L": [
      {"S": "Health: Chronic Illness"}
    ]},
    "evidence_quotes": {"L": [
      {"S": "Quote from transcript..."}
    ]},
    "reasoning": {"S": "Detailed explanation..."},
    "ai_version": {"S": "1.0"},
    "model_name": {"S": "claude-3.7-sonnet-20250219"},
    "review_status": {"S": "pending"},
    "transcript_s3_key": {"S": "..."},
    "expires_at": {"N": "..."}
  }
}
```

**Validation Checks:**
- ✅ `vulnerability_rating` is one of: Critical/5, High/4, Medium/3, Low/2, Marginal/1, None/0
- ✅ `vulnerability_types` array has at least one FCA category
- ✅ `evidence_quotes` array has direct quotes from transcript
- ✅ `reasoning` explains why this rating was chosen
- ✅ `review_status` is "pending"
- ✅ `expires_at` is ~90 days from now

### Step 7: Test Case with NO Vulnerabilities

Pick a meeting that should NOT trigger vulnerability assessment:

```bash
# Use a meeting with high pass rate and no vulnerability flags
aws stepfunctions start-execution \
  --state-machine-arn "arn:aws:states:eu-west-2:058264250790:stateMachine:case-checker-workflow" \
  --input '{
    "meetingId": "CLEAN_MEETING_ID",
    "forceReprocess": true
  }' \
  --region eu-west-2
```

**Expected Behavior:**
- Step Function should go: `CaseCheck` → `CheckVulnerability` → `A2IGateDecision` (skipping `AssessVulnerability`)
- No vulnerability assessment should be saved to DynamoDB

**Verify it was skipped:**
```bash
aws stepfunctions get-execution-history \
  --execution-arn "arn:aws:states:eu-west-2:058264250790:execution:case-checker-workflow:xxx" \
  --region eu-west-2 \
  | grep "AssessVulnerability"
```

Should return empty or show the state was not entered.

### Step 8: Test Error Handling

Test that the workflow continues even if vulnerability assessment fails:

```bash
# Temporarily break the Lambda (e.g., invalid Parameter Store name)
aws lambda update-function-configuration \
  --function-name call-summariser-AssessVulnerabilityFunction-* \
  --environment Variables='{
    "PROMPT_PARAM_NAME_VULNERABILITY": "/call-summariser/prompts/INVALID",
    "ASSESSMENT_TABLE_NAME": "assessment-results"
  }' \
  --region eu-west-2

# Trigger execution
aws stepfunctions start-execution \
  --state-machine-arn "arn:aws:states:eu-west-2:058264250790:stateMachine:case-checker-workflow" \
  --input '{
    "meetingId": "TEST_MEETING_ID",
    "forceReprocess": true
  }' \
  --region eu-west-2

# Wait for completion
sleep 30

# Check execution status - should still be SUCCEEDED
aws stepfunctions describe-execution \
  --execution-arn "arn:aws:states:eu-west-2:058264250790:execution:case-checker-workflow:xxx" \
  --region eu-west-2
```

**Expected Behavior:**
- Execution should still succeed (vulnerability assessment errors are caught)
- Check `$.vulnerabilityError` in execution history

**Fix the Lambda:**
```bash
aws lambda update-function-configuration \
  --function-name call-summariser-AssessVulnerabilityFunction-* \
  --environment Variables='{
    "PROMPT_PARAM_NAME_VULNERABILITY": "/call-summariser/prompts/vulnerability-assessment/current",
    "ASSESSMENT_TABLE_NAME": "assessment-results"
  }' \
  --region eu-west-2
```

### Step 9: Load Test (Optional)

Run multiple assessments in parallel:

```bash
# Create a test script
cat > test_parallel.sh << 'EOF'
#!/bin/bash
MEETING_IDS=("id1" "id2" "id3" "id4" "id5")

for id in "${MEETING_IDS[@]}"; do
  aws stepfunctions start-execution \
    --state-machine-arn "arn:aws:states:eu-west-2:058264250790:stateMachine:case-checker-workflow" \
    --input "{\"meetingId\": \"$id\", \"forceReprocess\": true}" \
    --region eu-west-2 &
done

wait
echo "All executions started"
EOF

chmod +x test_parallel.sh
./test_parallel.sh
```

**Monitor:**
- CloudWatch Lambda concurrency metrics
- Bedrock throttling errors
- DynamoDB throttling errors

### Step 10: Check Review Interface

Test that the assessment appears in the review interface:

```bash
# Get the review interface URL from CloudFormation outputs
aws cloudformation describe-stacks \
  --stack-name call-summariser \
  --query "Stacks[0].Outputs[?OutputKey=='VulnerabilityReviewInterfaceURL'].OutputValue" \
  --output text \
  --region eu-west-2
```

Visit the URL and verify:
- ✅ Meeting appears in the list
- ✅ Vulnerability rating is displayed correctly
- ✅ Evidence quotes are shown
- ✅ Reasoning is visible
- ✅ You can approve/reject the assessment

## Pre-Checkin Checklist

Before checking in your code, verify:

- [ ] `sam build` succeeds with no errors
- [ ] `sam deploy` completes successfully
- [ ] Parameter Store has correct prompt ARN
- [ ] Test meeting with vulnerability triggers assessment
- [ ] DynamoDB has correct assessment structure
- [ ] Test meeting without vulnerability skips assessment
- [ ] Error handling works (workflow continues even if assessment fails)
- [ ] Lambda logs show expected events
- [ ] CloudWatch has no unexpected errors
- [ ] Review interface displays assessments correctly
- [ ] All documentation is updated:
  - [ ] [docs/VULNERABILITY_ASSESSMENT_SETUP.md](docs/VULNERABILITY_ASSESSMENT_SETUP.md)
  - [ ] [setup/prompt_management/README.md](setup/prompt_management/README.md)
  - [ ] [setup/prompt_management/WORKFLOW.md](setup/prompt_management/WORKFLOW.md)
- [ ] Code follows existing patterns:
  - [ ] Error handling with `@lambda_error_handler()`
  - [ ] Logging with structured events
  - [ ] DynamoDB TTL calculation
  - [ ] S3 key validation
- [ ] No temporary files or backup files committed
- [ ] Template.yaml has correct IAM permissions
- [ ] Step Functions workflow JSON is valid

## Rollback Plan

If issues are found after deployment:

```bash
# Quick rollback via Parameter Store (reverts prompt only)
aws ssm put-parameter \
  --name "/call-summariser/prompts/vulnerability-assessment/current" \
  --value "arn:aws:bedrock:eu-west-2:058264250790:prompt/OQNE6VMD21:1" \
  --overwrite \
  --region eu-west-2

# Full rollback (reverts Lambda code)
aws cloudformation deploy \
  --template-file .aws-sam/build/template.yaml \
  --stack-name call-summariser \
  --capabilities CAPABILITY_IAM \
  --region eu-west-2 \
  --no-execute-changeset  # Review changes first
```

## Common Issues

### Issue: Execution doesn't trigger vulnerability assessment

**Diagnosis:**
```bash
# Check case check result
aws dynamodb query \
  --table-name assessment-results \
  --key-condition-expression "meeting_id = :mid AND begins_with(assessment_id, :prefix)" \
  --expression-attribute-values '{
    ":mid": {"S": "TEST_MEETING_ID"},
    ":prefix": {"S": "case-check#"}
  }' \
  --region eu-west-2
```

Look for `vulnerability_identified` check with status `Fail`.

### Issue: Lambda timeout

Increase timeout in [template.yaml](template.yaml:L467):
```yaml
Timeout: 180  # Increase to 300 if needed
```

### Issue: Bedrock throttling

Check CloudWatch metrics:
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/Bedrock \
  --metric-name ThrottledRequests \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Sum \
  --region eu-west-2
```

Request quota increase if needed.

## Success Criteria

All tests pass when:

1. ✅ Vulnerability detected → Assessment saved with valid rating
2. ✅ No vulnerability → Assessment skipped (not saved)
3. ✅ Assessment Lambda errors → Workflow continues (error caught)
4. ✅ DynamoDB structure matches schema
5. ✅ Review interface shows assessments
6. ✅ CloudWatch logs show success events
7. ✅ No unexpected errors in logs

## Next Steps After Checkin

1. Monitor production for 24-48 hours
2. Review assessment accuracy (human validation)
3. Adjust prompt if needed (no code deployment required!)
4. Build evals for vulnerability assessment quality
5. Set up CloudWatch alarms for errors
