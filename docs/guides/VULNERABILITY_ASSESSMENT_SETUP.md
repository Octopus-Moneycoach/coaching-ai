# Vulnerability Assessment Setup Guide

## Overview

The vulnerability assessment feature automatically evaluates customer vulnerabilities according to FCA FG21/1 guidance when the case check identifies potential issues.

## Architecture

```
Case Check Lambda
  ↓
  Identifies vulnerability (status=Fail on vulnerability_identified check)
  ↓
Step Functions (CheckVulnerability)
  ↓
Assess Vulnerability Lambda  ← Uses Bedrock Prompt Management
  ↓
Stores assessment in DynamoDB (assessment-results table)
```

## Setup Steps

### 1. Create Bedrock Prompt in AWS Console

1. Go to AWS Bedrock Console → Prompt Management
2. Click "Create prompt"
3. Enter the following details:

**Prompt Name**: `vulnerability-assessment-v1`
**Description**: `FCA FG21/1 customer vulnerability assessment for financial coaching conversations`

**Prompt Text**:
```
You are an expert vulnerability assessor for financial services. Analyze the following financial coaching conversation and assess the customer's vulnerability level according to FCA FG21/1 guidance.

VULNERABILITY RATING SCALE:
- Critical/5: Severe, multiple critical vulnerabilities (e.g., domestic violence, suicide risk, severe mental health crisis)
- High/4: Significant vulnerabilities requiring attention (e.g., chronic illness, learning difficulties, bereavement)
- Medium/3: Moderate vulnerabilities (e.g., temporary illness, low emotional resilience, situational anxiety)
- Low/2: Minor or potential vulnerabilities (e.g., low financial confidence, minor health issues)
- Marginal/1: Very minimal vulnerability indicators
- None/0: No vulnerability indicators

FCA FG21/1 VULNERABILITY CATEGORIES:
- Capability: Learning Difficulties, Low Confidence Financial Matters, Low Mental Capacity, Young Or Old Age, Poor Literacy Or Numeracy, Poor Digital Skills
- Health: Addiction, Chronic Illness, Mental Health Condition, Physical Disability, Visual Or Hearing Or Speech Impairment, Suicide, Temporary Illness Or Hospitalisation Or Accident
- Life Events: Bereavement, Caring Responsibilities, Divorce Or Separation, Relationship Breakdown, Domestic Violence, Homeless, Income Shock
- Resilience: Lack Of Support Network, Low Emotional Resilience, Low Or Erratic Income, Low Savings, Over-indebtedness

TRANSCRIPT:
{{cleaned_transcript}}

TASK:
Provide your assessment using the submit_vulnerability_assessment tool with:
- rating: Vulnerability rating (e.g., "Medium/3")
- vulnerability_types: Array of FCA categories (e.g., ["Health: Chronic Illness"])
- evidence: Array of direct quotes from transcript, one per vulnerability type
- reasoning: Detailed explanation of why this rating was assigned, referencing specific evidence and explaining how vulnerabilities combine to justify the severity rating

IMPORTANT:
- Only include vulnerability types with clear evidence in the transcript
- Evidence array must contain direct quotes from the transcript
- Reasoning must explain WHY this rating was chosen
- Be conservative - don't over-identify vulnerabilities without evidence
- Focus on the CUSTOMER's vulnerabilities, not the coach's performance
```

**Model Configuration**:
- Model: `anthropic.claude-3-7-sonnet-20250219-v1:0`
- Temperature: `0.0`
- Max tokens: `3000`

**Input Variables**:
- `cleaned_transcript` (type: string)

4. Click "Create"
5. Note the Prompt ARN (format: `arn:aws:bedrock:eu-west-2:ACCOUNT_ID:prompt/PROMPT_ID`)

### 2. Store Prompt ARN in Parameter Store

```bash
aws ssm put-parameter \
  --name "/call-summariser/prompts/vulnerability-assessment/current" \
  --value "arn:aws:bedrock:eu-west-2:ACCOUNT_ID:prompt/PROMPT_ID" \
  --type String \
  --description "Current Bedrock prompt ARN for vulnerability assessment" \
  --region eu-west-2 \
  --overwrite
```

Replace `ACCOUNT_ID` and `PROMPT_ID` with actual values from step 1.

### 3. Deploy the Stack

```bash
cd /Users/pree/Documents/AI\ POCs/call-summariser/call-summariser
sam build
sam deploy
```

### 4. Test the Flow

#### Trigger Case Check with Vulnerability:

```bash
aws stepfunctions start-execution \
  --state-machine-arn "arn:aws:states:eu-west-2:ACCOUNT_ID:stateMachine:case-checker-workflow" \
  --input '{
    "meetingId": "TEST_MEETING_ID",
    "forceReprocess": true
  }' \
  --region eu-west-2
```

#### Check Results:

```bash
aws dynamodb get-item \
  --table-name assessment-results \
  --key '{"meeting_id":{"S":"TEST_MEETING_ID"},"assessment_id":{"S":"vulnerability#TEST_MEETING_ID"}}' \
  --region eu-west-2
```

Expected output structure:
```json
{
  "meeting_id": "TEST_MEETING_ID",
  "assessment_id": "vulnerability#TEST_MEETING_ID",
  "vulnerability_rating": "Medium/3",
  "vulnerability_types": ["Health: Chronic Illness"],
  "evidence_quotes": ["Direct quote from transcript"],
  "reasoning": "Detailed explanation...",
  "ai_version": "1.0",
  "model_name": "claude-3.7-sonnet-20250219",
  "review_status": "pending"
}
```

## DynamoDB Schema

### assessment-results Table

**Primary Key**:
- `meeting_id` (String) - Partition key
- `assessment_id` (String) - Sort key (format: `vulnerability#{meeting_id}`)

**Attributes**:
- `assessment_type`: "vulnerability"
- `vulnerability_rating`: e.g., "Critical/5", "High/4", "Medium/3"
- `vulnerability_types`: Array of FCA FG21/1 categories
- `evidence_quotes`: Array of direct quotes from transcript
- `reasoning`: Detailed explanation
- `ai_version`: Prompt version
- `model_name`: Model identifier
- `review_status`: "pending" | "approved" | "rejected"
- `transcript_s3_key`: Link to source transcript
- `expires_at`: TTL (90 days)

## Monitoring

### CloudWatch Logs

**Log Groups**:
- `/aws/lambda/call-summariser-AssessVulnerabilityFunction-*`
- `/aws/states/case-checker-workflow`

**Key Log Events**:
- `VULNERABILITY_ASSESSMENT_START`
- `VULNERABILITY_ASSESSMENT_LLM_OK`
- `VULNERABILITY_ASSESSMENT_SAVED`

### Metrics

- Lambda Duration (AssessVulnerabilityFunction)
- Bedrock InvokeModel API calls
- DynamoDB PutItem operations

## Cost Estimation

**Per vulnerability assessment**:
- Claude 3.7 Sonnet: ~10K input tokens + 1K output tokens
- Input: $3/million tokens = ~$0.03
- Output: $15/million tokens = ~$0.015
- **Total per assessment**: ~$0.045

**Expected volume**:
- ~30% of calls trigger vulnerability assessment
- If processing 1000 calls/month: 300 assessments
- Monthly cost: ~$13.50

## Troubleshooting

### Prompt Not Found Error

```
Error: Prompt Management is required but prompt ARN not available
```

**Solution**: Verify Parameter Store has correct ARN:
```bash
aws ssm get-parameter --name "/call-summariser/prompts/vulnerability-assessment/current" --region eu-west-2
```

### Assessment Not Saved

Check Lambda logs for `ASSESSMENT_TABLE_UPDATE_FAILED` error.

Common causes:
- Missing DynamoDB permissions
- Table doesn't exist
- TTL calculation error

### No Vulnerability Detected

The case check must return `hasVulnerability: true` for assessment to trigger.

Check case check output:
```bash
aws dynamodb scan \
  --table-name assessment-results \
  --filter-expression "assessment_id = :aid AND check_id = :cid" \
  --expression-attribute-values '{":aid":{"S":"case-check#vulnerability_identified"},":cid":{"S":"vulnerability_identified"}}' \
  --region eu-west-2
```

## Review Interfaces

- Meeting-level: http://coach-review-interface-vulnerability.s3-website.eu-west-2.amazonaws.com/
- Multi-model comparison: http://coach-review-interface-vulnerability.s3-website.eu-west-2.amazonaws.com/comparison.html
